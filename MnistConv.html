<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>myTensorflow, MNIST LeNet-5-like convolutional</title>
<style type="text/css">
<!--
body { background-color:#ededed; font:norm2al 12px/18px Arial, Helvetica, sans-serif; }
h1 { display:block; width:600px; margin:20px auto; paddVing-bottom:20px; font:norm2al 24px/30px Georgia, "Times New Roman", Times, serif; color:#333; text-shadow: 1px 2px 3px #ccc; border-bottom:1px solid #cbcbcb; }
#container { width:600px; margin:0 auto; }
#trainingErrorPlot { background:#fff; border:1px solid #cbcbcb; }
#nav { display:block; width:100%; text-align:center; }
#nav li { display:block; font-weight:bold; line-height:21px; text-shadow:1px 1px 1px #fff; width:100px; height:21px; paddVing:5px; margin:0 10px; background:#e0e0e0; border:1px solid #ccc; -moz-border-radius:4px;-webkit-border-radius:4px; border-radius:4px; float:left; }
#nav li a { color:#000; display:block; text-decoration:none; width:100%; height:100%; }
-->
</style>
<script type="text/javascript" src="src/ActivationSigmoidLayer.js"></script>
<script type="text/javascript" src="src/ActivationReluLayer.js"></script>
<script type="text/javascript" src="src/ArgMaxLayer.js"></script>
<script type="text/javascript" src="src/AveragePool1DLayer.js"></script>
<script type="text/javascript" src="src/AveragePool2DLayer.js"></script>
<script type="text/javascript" src="src/ConvHelpers.js"></script>
<script type="text/javascript" src="src/Conv1DLayer.js"></script>
<script type="text/javascript" src="src/Conv2DLayer.js"></script>
<script type="text/javascript" src="src/Conv3DLayer.js"></script>
<script type="text/javascript" src="src/CostQuadraticLayer.js"></script>
<script type="text/javascript" src="src/CostCrossEntropyLayer.js"></script>
<script type="text/javascript" src="src/CostArgMaxCrossEntropyLayer.js"></script>
<script type="text/javascript" src="src/FlattenLayer.js"></script>
<script type="text/javascript" src="src/FullyConnectedLayer.js"></script>
<script type="text/javascript" src="src/InputLayer.js"></script>
<script type="text/javascript" src="src/MaxPool1DLayer.js"></script>
<script type="text/javascript" src="src/MaxPool2DLayer.js"></script>
<script type="text/javascript" src="src/Network.js"></script>
<script type="text/javascript" src="src/Matrix.js"></script>
<script type="text/javascript" src="src/RegDropoutLayer.js"></script>
<script type="text/javascript" src="helpers/GraphHelper.js"></script>
<script type="text/javascript" src="mnist/MnistHelper.js"></script>
</head>
<script>

//-------------------------------
var mnist;

var network = []
var outputs = [];

var results_training;
var results_validation;

var trainingSetScoreBoard = null;
var trainingErrorPlot = null;

var iterations = 0;
var learningRate = .001;

function vectorFromIdx(i)
{
    var v = Array(10).fill(0);
    v[i] = 1;
    return [[[v]]];
}

function getMaxIdxInVector(vv)
{
    var v = vv[0][0][0]
    return v.indexOf(Math.max.apply(null, v));
}

function iterate2(inputs, labels, results, offset, size, batchSize, training)
{   
    assert((size % batchSize) == 0);
    
    var totalErr = 0;
    var correct = 0;

    for(var i=offset;i<(offset+size);i+=batchSize)
    {    
        for(var j=i;j<(i+batchSize);j++)
        {
            network[network.length-1].setValue(vectorFromIdx(labels[j]));
            
            totalErr += ForwardPropagation(network, inputs[j])[0][0][0][0];
                    
            // get prediction        
            var output = network[network.length-1].input;                
            var index = getMaxIdxInVector(output)            
            
            results[j] = index;
            
            if (index == labels[j])
                correct++;        
                                    
            if (training)
            {
                BackwardPropagation(network);        
            }            
        }            
        
        if (training)
        {
            ApplyDeltas(network, learningRate/batchSize);    
        }        
    }    
    
    return {correct: correct, totalErr: totalErr / size};
}

var lastTrainingError = 0;
function iterate()
{  
    iterations++;

    // train
    { 
		var offset=0;
        var len = mnist.training_images.length;
        var batchSize = 1;
		
		var t0 = performance.now();
		
		var res = iterate2(mnist.training_images_conv, mnist.training_labels, results_training, offset, len, batchSize, true);

		var t1 = performance.now();
		var milliseconds = (t1 - t0);

		if (iterations>1)
		{
			trainingErrorPlot.AddSegment(iterations-1,lastTrainingError,iterations,res.totalErr, "#ff0000")
		}
		lastTrainingError = res.totalErr

		document.getElementById("perfText").innerHTML = "Epocs:" + iterations + " Epocs/sec: " + (1000.0 / milliseconds).toFixed(2) + "<br>"
		document.getElementById("trainingText").innerHTML = "Num items: " + len + " Correct: " + res.correct + " ("+ (res.correct*100/len).toFixed(2) +"% ) Error: " + res.totalErr + " <br> ";
			
		trainingSetScoreBoard.Draw(mnist.training_images, mnist.training_labels, results_training, offset);
    }
        
    /*    
    // test    
    {   
        var offset = 3000; 
        var len = 400;
        
        //testSetScoreBoard.Draw(mnist.inputs, mnist.labels, results, offset);
        
        var res = iterate2(mnist.inputs, mnist.labels, results, offset, len, 100, false);    
        
        document.getElementById("testText").innerHTML = "Num items: " + len + " Correct: " + res.correct + " ("+ (res.correct*100/len).toFixed(2) +"% ) Error: " + res.totalErr + " <br> ";        
    }
    */
}

function init()
{   
    GetMnistInputs().then(function(data)
	{    
		mnist=[]
		// choose validation set
		mnist.validation_images = data.inputs.slice(3000,6000)
		mnist.validation_labels = data.labels.slice(3000,6000)	
		results_validation = Array(mnist.validation_labels.length).fill(-1);
		
		// choose training set
		mnist.training_images = data.inputs.slice(0,10)
		mnist.training_labels = data.labels.slice(0,10)	
		results_training = Array(mnist.training_labels.length).fill(-1);
		
		// convert inputs into a shape than can be used with convolutions
		mnist.training_images_conv = []
		for(var i=0;i<mnist.training_images.length;i++)
		{
			var v = TensorRandom(1, 1, 28, 28)
			for (var y=0;y<28;y++)
			{
				for (var x=0;x<28;x++)
				{
					v[0][0][y][x] = mnist.training_images[i][x + y*28];
				}
			}
			
			mnist.training_images_conv[i] = v;
		}
		
		trainingSetScoreBoard = new ScoreBoard("trainingSetScoreBoard");
		trainingSetScoreBoard.Draw(mnist.training_images, mnist.training_labels, results_training, 0);

		trainingErrorPlot = new Graph("trainingErrorPlot",-20,400, 500,-50);
		trainingErrorPlot.DrawXMax();
		trainingErrorPlot.DrawYMin();

		var weights1 = TensorRandom(32, 1, 5, 5);  
		var bias1 = RandomVec(32);
		
		var weights2 = TensorRandom(64, 32, 5, 5);  
		var bias2 = RandomVec(64);

		var weights3 = TensorRandom(1,1, 7*7*64, 1024); 
		var bias3 = RandomVec(1024);

		var weights4 = TensorRandom(1,1, 1024, 10); 
		var bias4 = RandomVec(10);

		   
		network.push(new InputLayer());
		network.push(new Conv2DLayer(weights1, bias1));
		//network.push(new ActivationReluLayer());
		network.push(new ActivationSigmoidLayer());
		network.push(new MaxPool2DLayer());
		network.push(new Conv2DLayer(weights2, bias2));
		//network.push(new ActivationReluLayer());
		network.push(new ActivationSigmoidLayer());
		network.push(new MaxPool2DLayer());
		network.push(new FlattenLayer());
		network.push(new FullyConnectedLayer(weights3, bias3));
		//network.push(new ActivationReluLayer());
		network.push(new ActivationSigmoidLayer());
		network.push(new FullyConnectedLayer(weights4, bias4));
		network.push(new CostQuadraticLayer());
		   
		setInterval(iterate,10); 		
	});	
}
</script>


<body onload="init()">
<h1>MNIST LeNet-5-like convolutional</h1>
<div id="container">
<h2>Intro</h2>
<p>Warning! This online demo is very slow. It trains CNNs in your browser to recognize digits from the MNIST set.</p>
<p>It uses the following architecture:
<ul>
  <li>CNN, 5x5 kernel, 32 filters </li>
  <li>CNN, 5x5 kernel, 64 filters</li>
  <li>Max pool layer</li>
  <li>Fully connected layer</li>
</ul>  
</p>
<h2>Training and Validation Loss</h2>
<canvas id="trainingErrorPlot" width="600" height="100"></canvas>
<div id="perfText"></div>
<h2>Predictions</h2>
<p>Just showing the training set, just 10 images so it is not that slow!</p>
<div id="trainingText"></div>
<canvas id="trainingSetScoreBoard" width="600" height="32"></canvas>
<h2>Contact/Questions:</h2>
 &lt;my_github_account_username&gt;$@gmail.com$.
</br>
</br>
</div>
</body>
</html>
